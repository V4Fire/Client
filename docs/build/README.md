# V4Fire Сборка <!-- omit in toc -->

- [Введение](#введение)
- [Предусловия](#предусловия)
- [Концептуальное описание сборки](#концептуальное-описание-сборки)
- [Конфигурация](#конфигурация)
- [Граф зависимостей](#граф-зависимостей)
- [PZLR](#pzlr)
- [Advanced](#advanced)
  - [Особенности сборки snakeskin](#особенности-сборки-snakeskin)
  - [Особенности сборки стилей](#особенности-сборки-стилей)

## Введение

Для сборки используется [`webpack5`](https://webpack.js.org/concepts/)
и [`pzlr`](https://github.com/pzlr/build-core).
Конфигурация сборки и окружения осуществляется с помощью библиотеки [`config`](https://www.npmjs.com/package/config/v/1.31.0).

Также мы активно используем библиотеку [`monic`](https://www.npmjs.com/package/monic),
которая позволяет в зависимости от параметров окружения вырезать/заменять/добавлять части исходного кода.

## Предусловия

- Ожидается, что проект реализован в качестве [слоенного монорепозитория](https://youtu.be/tpoZP---L7k).
- Создать в корне проекта файл `.pzlrrc` - здесь необходимо указать слои проекта (`dependencies`),
директорию с исходным кодом и иные параметры.
- Создать в корне проекта файл `.tsconfig`, при необходимости можно создать файл `client.tsconfig`
со специфичными параметрами для сборки.
- В директории `src/entries` создать файлы входных точек (`entrypoints`) для `webpack`.

## Концептуальное описание сборки

При запуске `npm run build` создается `tsconfig.json`, а затем вызывается CLI `webpack`.

> У каждого проекта разный набор слоев, поэтому `tsconfig.json` создается динамически,
> с помощью `pzlr` генерируются правильные пути для компилятора TS (`compilerOptions.paths`).

Конфиг `webpack` генерируется автоматически (см. `webpack.config.js`).

Перед генерацией конфига в первую очередь подключается модуль `build/snakeskin`,
который добавляет в `snakeskin` различные фильтры, а также поддержку импортов из слоев.

Затем с помощью графа зависимостей (`build/graph`) генерируются конфиги процессов `webpack`
(для параллелизации). Каждый процесс отвечает за свою часть сборки: стили, js, html и т.д.

> Мы ещё не раз столкнемся с графом зависимостей (`build/graph`),
> его назначение и функции будут описаны позже.
> Сейчас достаточно понимать, что он оптимизирует скорость сборки проекта.

В момент построения графа создаются конечные входные точки в директории `src/entries/tmp`,
которые затем будут переданы в качестве параметра `entry` в `webpack`.

> Промежуточные файлы входных точек создаются для того, чтобы оптимизировать импорты стилей, шаблонов
> и исходного кода из слоев проекта.
> Рекурсивно добавляются необходимые `require` согласно указанным
[зависимостям компонента](https://github.com/V4Fire/Client/wiki/Базовое-создание-компонента#indexjs),
> при этом происходит автоматическое разрешение путей к файлам с исходным кодом с учетом их местоположения
> в иерархии слоев.

Для каждого процесса формируется своя конфигурация с помощью модулей,
которые расположены в директории `build/webpack`, названия модулей совпадают
с параметрами конфигурации `webpack`, например: module, alias, output и т.д.

> Стоит обратить внимание, что для импорта модулей используется функция [`include`](https://github.com/V4Fire/Core/blob/v4/build/include.js)
> она ищет модуль по слоям проекта, что позволяет переопределять модули в вышележащих слоях.

Далее осуществляется сборка:
- Шаблоны `snakeskin` компилируются в низкоуровневые команды Vue.
- `stylus` собирается с использованием кастомных плагинов, которые расположены в директории [`build/stylus`](/build/stylus).
- TypeScript собирается с помощью `ts-loader`.

Практически все типы файлов перед сборкой предварительно обрабатываются с помощью `monic`:
- Импорты с использованием `@super` разрешаются относительно нижележащего слоя.
- Разрешает `@context` импорты (см. `components/directives/icon`)
- Преобразовывает динамические импорты компонентов в группу импортов: стилей, шаблонов и исходного кода.
- Подгружает зависимости компонентов: шаблоны, стили и т.д.

## Конфигурация

Конфиги расположены в директории `config`. Как говорилось ранее используется библиотека [`config`](https://www.npmjs.com/package/config/v/1.31.0).
Здесь указываются следующие параметры:

- движок рендера, по-умолчанию: `vue3`
- параметры сборки: режим, кол-во CPU под сборку и др.
- параметры webpack: режим, тип кэширования, SSR сборка и др.
- тема приложения
- параметры стилей, snakeskin, monic и т.д.

Управлять параметрами конфигурации при сборке, можно с помощью флага `--env`,
например:

```
npx webpack --env build-mode=production
```

Либо с помощью `.env` файла:

```
BUILD_MODE=production
```

## Граф зависимостей

TODO: описать назначение и функции

## PZLR

TODO: описать назначение и функции

## Advanced

### Особенности сборки snakeskin

TODO

### Особенности сборки стилей

TODO

